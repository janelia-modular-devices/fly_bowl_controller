* Header                                                           :noexport:

  #+MACRO: name fly_bowl_controller
  #+MACRO: version 1.0
  #+MACRO: license BSD, Open-Source Hardware
  #+MACRO: url https://github.com/janelia-modular-devices/fly_bowl_controller
  #+AUTHOR: Peter Polidoro
  #+EMAIL: peterpolidoro@gmail.com

* Description

  This device controls the IR and visible backlights in the fly bowl rig along
  with the backlight cooling fans and indicator lights.

* Usage Instructions

** Arduino Serial Monitor

   #+BEGIN_SRC json
     getDeviceId
     {
       "id": "getDeviceId",
       "result": {
         "name": "fly_bowl_controller",
         "form_factor": "5x3",
         "serial_number": 0
       }
     }
     setPropertiesToDefaults [ALL]
     {
       "id": "setPropertiesToDefaults",
       "result": null
     }
     flyBowlsEnabled getValue
     {
       "id": "flyBowlsEnabled",
       "result": [
         true,
         true,
         true,
         true
       ]
     }
     flyBowlsEnabled setValue [true,false,true,false]
     {
       "id": "flyBowlsEnabled",
       "result": [
         true,
         false,
         true,
         false
       ]
     }
     setIrBacklightsOnAtPower 90
     {
       "id": "setIrBacklightsOnAtPower",
       "result": null
     }
     setVisibleBacklightsOnAtPower 68
     {
       "id": "setVisibleBacklightsOnAtPower",
       "result": null
     }
     setVisibleBacklightsOff
     {
       "id": "setVisibleBacklightsOff",
       "result": null
     }
     addVisibleBacklightsPwm ?
       {
         "id": "addVisibleBacklightsPwm",
         "result": {
           "name": "addVisibleBacklightsPwm",
           "firmware": "FlyBowlController",
           "parameters": [
             "power",
             "pulse_delay",
             "pulse_period",
             "pulse_on_duration",
             "pulse_count"
           ],
           "result_info": {
             "type": "long"
           }
         }
       }
     addVisibleBacklightsPwm 100 5000 100 50 1000
     {
       "id": "addVisibleBacklightsPwm",
       "result": 0
     }
     stopPwm 0
     {
       "id": "stopPwm",
       "result": null
     }
     setIrBacklightsOff
     {
       "id": "setIrBacklightsOff",
       "result": null
     }
   #+END_SRC

** Python

   #+BEGIN_SRC python
     from modular_client import ModularClient
     dev = ModularClient() # Automatically finds device if one available
     dev.get_device_id()
     {'name': 'fly_bowl_controller', 'form_factor': '5x3', 'serial_number': 0}
     dev.set_properties_to_defaults(['ALL'])
     dev.fly_bowls_enabled('getValue')
     [True, True, True, True]
     dev.fly_bowls_enabled('setValue',[True,False,True,False])
     [True, False, True, False]
     dev.set_ir_backlights_on_at_power(90) # Automatically turns fans on too
     dev.set_visible_backlights_on_at_power(68)
     dev.set_visible_backlights_off()
     dev.add_visible_backlights_pwm('?')
     {'name': 'addVisibleBacklightsPwm',
      'firmware': 'FlyBowlController',
      'parameters': ['power',
                     'pulse_delay',
                     'pulse_period',
                     'pulse_on_duration',
                     'pulse_count'],
      'result_info': {'type': 'long'}}

         power = 100 # 100%
         delay = 5000 # 5000ms
         period = 100 # 100ms
         on_duration = 50 # 50ms
         count = 1000
         pwm_index = dev.add_visible_backlights_pwm(power,delay,period,on_duration,count)
         dev.stop_pwm(pwm_index)
         dev.set_ir_backlights_off() # Automatically turns fans off too
   #+END_SRC

** Matlab

   #+BEGIN_SRC matlab
     % Linux and Mac OS X
     ls /dev/tty*
     serial_port = '/dev/ttyACM0'     % example Linux serial port
     serial_port = '/dev/tty.usbmodem262471' % example Mac OS X serial port
                                             % Windows
     getAvailableComPorts()
     ans =
     'COM1'
     'COM4'
     serial_port = 'COM4';             % example Windows serial port
     dev = ModularClient(serial_port); % creates a device object
     dev.open();                       % opens a serial connection to the device
     dev.getDeviceId()
     ans =
     name: 'fly_bowl_controller'
     form_factor: '5x3'
     serial_number: 0
     dev.setPropertiesToDefaults({'ALL'});
     dev.flyBowlsEnabled('getValue')
     [1]    [1]    [1]    [1]
     dev.flyBowlsEnabled('setValue',{true,false,true,false})
     [1]    [0]    [1]    [0]
     dev.setIrBacklightsOnAtPower(90);
     dev.setVisibleBacklightsOnAtPower(68);
     dev.setVisibleBacklightsOff();
     power = 100; % 100%
     delay = 5000; % 5000ms
     period = 100; % 100ms
     on_duration = 50; % 50ms
     count = 1000;
     pwm_index = dev.addVisibleBacklightsPwm(power,delay,period,on_duration,count);
     dev.stopPwm(pwm_index);
     dev.setIrBacklightsOff();
     dev.close();
     clear dev;
   #+END_SRC

* Build Instructions
